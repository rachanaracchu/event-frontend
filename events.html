<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin - Manage Events</title>
<style>
body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
form input, form select, form button { padding: 8px; margin: 5px; }
button { cursor: pointer; }
table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
.edit-btn { background: orange; color: white; }
.delete-btn { background: red; color: white; }
</style>
</head>
<body>

<h2>Event Management</h2>

<form id="eventForm">
  <input type="text" id="name" placeholder="Event Name" required />
  
  <select id="type" required>
    <option value="">Select Event Type</option>
    <option value="Marriage">Marriage</option>
    <option value="Birthday">Birthday</option>
    <option value="College">College</option>
    <option value="Corporate">Corporate</option>
  </select>

  <select id="subType" required>
    <option value="">Select Sub-Type</option>
  </select>

  <input type="date" id="date" required />
  <input type="text" id="location" placeholder="Location" required />
  <input type="number" id="price" placeholder="Price" required />
  <button type="submit">Add / Update Event</button>
</form>

<table>
  <thead>
    <tr>
      <th>Name</th><th>Type</th><th>Sub-Type</th><th>Date</th><th>Location</th><th>Price</th><th>Actions</th>
    </tr>
  </thead>
  <tbody id="eventTable"></tbody>
</table>

<script>
let editEventId = null;

// Populate sub-type dropdown dynamically
document.getElementById("type").addEventListener("change", function() {
  const type = this.value;
  const subTypeSelect = document.getElementById("subType");
  subTypeSelect.innerHTML = '<option value="">Select Sub-Type</option>';

  if(type === "Marriage") ["Destination","Temple","Theme","Local"].forEach(t=>{ let o=document.createElement("option"); o.value=t; o.textContent=t; subTypeSelect.appendChild(o); });
  else if(type === "Birthday") ["Kids","Teen","Adult","Surprise"].forEach(t=>{ let o=document.createElement("option"); o.value=t; o.textContent=t; subTypeSelect.appendChild(o); });
  else if(type === "College") ["Cultural Fest","Technical Fest","Sports Meet","Freshers/Graduation"].forEach(t=>{ let o=document.createElement("option"); o.value=t; o.textContent=t; subTypeSelect.appendChild(o); });
  else if(type === "Corporate") ["Seminar","Product Launch","Team Building","Annual Meet"].forEach(t=>{ let o=document.createElement("option"); o.value=t; o.textContent=t; subTypeSelect.appendChild(o); });
});

// Fetch and display events
async function fetchEvents() {
  const res = await fetch("http://localhost:8075/api/event");
  const events = await res.json();
  const tbody = document.getElementById("eventTable");
  tbody.innerHTML = "";

  events.forEach(e => {
    const subType = e.marriage_type || e.birthday_theme || e.college_type || e.corporate_type || "";
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${e.name}</td>
      <td>${e.type}</td>
      <td>${subType}</td>
      <td>${e.date}</td>
      <td>${e.location}</td>
      <td>${e.price}</td>
      <td>
        <button class="edit-btn" onclick='editEvent(${JSON.stringify(e)})'>Edit</button>
        <button class="delete-btn" onclick='deleteEvent(${e.id})'>Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });
}

// Edit event
function editEvent(e) {
  editEventId = e.id;
  document.getElementById("name").value = e.name;
  document.getElementById("type").value = e.type;
  document.getElementById("date").value = e.date;
  document.getElementById("location").value = e.location;
  document.getElementById("price").value = e.price;

  // Populate subType
  const subType = e.marriage_type || e.birthday_theme || e.college_type || e.corporate_type || "";
  const subTypeSelect = document.getElementById("subType");
  subTypeSelect.innerHTML = `<option value="${subType}">${subType}</option>`;
}

// Delete event
async function deleteEvent(id) {
  if(confirm("Are you sure you want to delete this event?")) {
    await fetch(`http://localhost:8075/api/event/${id}`, { method: "DELETE" });
    fetchEvents();
  }
}

// Handle add/update form
document.getElementById("eventForm").addEventListener("submit", async e => {
  e.preventDefault();
  const type = document.getElementById("type").value;
  const subType = document.getElementById("subType").value;

  const event = {
    name: document.getElementById("name").value.trim(),
    type,
    date: document.getElementById("date").value,
    location: document.getElementById("location").value.trim(),
    price: parseFloat(document.getElementById("price").value),
    marriage_type: type==="Marriage"?subType:"",
    birthday_theme: type==="Birthday"?subType:"",
    college_type: type==="College"?subType:"",
    corporate_type: type==="Corporate"?subType:""
  };

  const url = editEventId ? `http://localhost:8075/api/event/${editEventId}` : `http://localhost:8075/api/event`;
  const method = editEventId ? "PUT" : "POST";

  await fetch(url, {
    method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(event)
  });

  editEventId = null;
  e.target.reset();
  fetchEvents();
});

// Initial load
fetchEvents();
</script>

</body>
</html>
